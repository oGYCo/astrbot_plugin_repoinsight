# RepoInsight - GitHub仓库智能问答插件

## 简介

RepoInsight 是一个为 AstrBot 开发的插件，它能够分析 GitHub 仓库并提供智能问答功能。通过集成 GithubBot 服务，用户可以轻松地对任何公开的 GitHub 仓库进行深度分析和智能问答。

## 功能特性

- 🔍 **仓库分析**: 自动分析 GitHub 仓库的代码结构和内容
- 💬 **智能问答**: 基于仓库内容回答用户问题
- �  **仓库切换**: 支持在问答过程中快速切换到其他仓库
- 💾 **状态持久化**: 支持插件重启后恢复未完成任务
- ⚙️ **灵活配置**: 支持自定义 Embedding 和 LLM 配置
- 🔄 **会话管理**: 支持多轮对话和会话控制
- ⏰ **智能超时**: 30分钟问答会话超时，避免意外退出
- 🛡️ **重复检测**: 智能防止重复问题处理（30秒窗口）

## 安装要求

### 前置条件

1. **AstrBot**: 确保已安装并配置好 AstrBot
2. **GithubBot 服务**: 需要运行 GithubBot 后端服务
3. **Python 依赖**: 插件会自动安装所需依赖

### 依赖包

- `aiohttp>=3.8.0`: 用于 HTTP 异步请求
- `aiosqlite>=0.19.0`: 用于状态持久化存储

## 配置说明

插件支持通过 AstrBot 的配置界面进行可视化配置，主要配置项包括：

### API 配置

- **GithubBot API 地址**: GithubBot 服务的基础 URL（默认: `http://api:8000`）（用于容器之间的通信）
- **请求超时时间**: HTTP 请求超时时间，单位秒（默认: 30）
- **轮询间隔**: 状态轮询间隔时间，单位秒（默认: 5）

> **注意**: 问答会话的超时时间固定为30分钟（1800秒），不受HTTP请求超时时间影响。这为用户提供了充足的思考和分析时间。

### Embedding 配置

用于代码向量化的配置：

- **提供商**: 支持 `openai`、`azure`、`huggingface`、`local`、`qwen`
- **模型名称**: 如 `text-embedding-3-small`、`text-embedding-3-large`
- **API 密钥**: 对应服务的 API 密钥
- **API 基础地址**: 自定义 API 端点（可选）
- **额外参数**: 传递给服务的额外参数

### LLM 配置

用于生成答案的大语言模型配置：

- **提供商**: 支持 `openai`、`azure`、`anthropic`、`local`、`qwen`
- **模型名称**: 如 `gpt-4`、`gpt-4-turbo`、`claude-3-sonnet`
- **API 密钥**: 对应服务的 API 密钥
- **温度**: 控制生成随机性（0.0-2.0，默认: 0.7）
- **最大令牌数**: 生成回答的最大长度（默认: 2000）

## 使用方法

### 基本命令

1. **启动仓库问答会话**
   ```
   /repo_qa
   ```
   启动交互式会话，按提示输入 GitHub 仓库 URL 进行分析和问答。

2. **查看分析状态**
   ```
   /repo_status
   ```
   查看当前用户的仓库分析任务状态。

3. **查看配置信息**
   ```
   /repo_config
   ```
   显示当前插件的配置信息。

### 使用流程

1. **发送命令**: 在聊天中发送 `/repo_qa`
2. **输入仓库 URL**: 按提示输入要分析的 GitHub 仓库 URL
   - 格式: `https://github.com/用户名/仓库名`
   - 示例: `https://github.com/microsoft/vscode`
3. **等待分析**: 插件会静默分析仓库（不显示进度消息）
4. **开始问答**: 分析完成后，可以开始提问
5. **切换仓库**: 在问答过程中可以：
   - 发送 `/repo_qa` 命令切换到新仓库
   - 直接发送新的 GitHub URL 快速切换
6. **退出会话**: 发送 `退出`、`exit`、`quit` 或 `取消` 结束会话

### 新功能说明

#### 🔄 仓库切换功能
在问答会话中，您可以随时切换到其他仓库：

**方法一：使用命令**
```
/repo_qa
```
系统会提示您输入新的仓库URL

**方法二：直接输入URL**
```
https://github.com/新用户名/新仓库名
```
系统会自动检测并切换到新仓库

#### ⏰ 智能会话管理
- **延长超时**: 问答会话超时时间为30分钟，给用户充足的思考时间
- **重复检测**: 30秒内的重复问题会被智能检测并提示
- **会话恢复**: 超时后可以随时重新开始，无需重新分析仓库

### 问答示例

分析完成后，您可以提出各种问题：

- "这个项目的主要功能是什么？"
- "如何安装和使用这个项目？"
- "项目的架构是怎样的？"
- "有哪些主要的模块和组件？"
- "如何贡献代码到这个项目？"

### 高级用法

#### 多仓库问答工作流
1. 分析第一个仓库并进行问答
2. 在会话中切换到相关仓库进行对比分析
3. 无缝在多个仓库间切换，提高研究效率

#### 会话管理技巧
- 利用30分钟超时时间进行深度思考和分析
- 避免在30秒内重复提问相同问题
- 合理利用仓库切换功能进行项目对比

## 故障排除

### 常见问题

1. **连接 GithubBot 服务失败**
   - 检查 GithubBot 服务是否正常运行
   - 确认 API 地址配置正确
   - 检查网络连接

2. **分析失败**
   - 确认仓库 URL 格式正确
   - 检查仓库是否为公开仓库
   - 查看 GithubBot 服务日志

3. **问答无响应**
   - 检查 LLM 配置是否正确
   - 确认 API 密钥有效
   - 查看插件日志信息

4. **会话意外结束**
   - 检查是否在30分钟内无活动导致超时
   - 重新发送 `/repo_qa` 命令即可恢复
   - 已分析的仓库无需重新分析

5. **重复问题提示**
   - 系统检测到30秒内的重复问题
   - 等待30秒后重新提问，或稍微修改问题表述
   - 这是为了防止网络延迟导致的重复提交

6. **仓库切换失败**
   - 确认新仓库URL格式正确
   - 检查新仓库是否为公开仓库
   - 如果切换失败，会自动回到原仓库继续问答

### 日志查看

插件会在 AstrBot 日志中记录详细的运行信息，包括：
- 任务启动和完成状态
- API 请求和响应
- 错误信息和异常

## 开发说明

### 项目结构

```
astrbot_plugin_repoinsight/
├── main.py                 # 主插件文件
├── requirements.txt        # 依赖包列表
├── _conf_schema.json      # 配置模式定义
├── README.md              # 说明文档
└── data/                  # 数据目录（自动创建）
    └── repoinsight_tasks.db  # 任务状态数据库
```

### 核心组件

- **Main**: 主插件类，处理命令和会话管理
- **StateManager**: 状态管理器，负责任务持久化存储
- **session_waiter**: 会话控制器，处理用户交互和超时管理
- **重复检测系统**: 基于时间窗口的智能重复问题检测
- **仓库切换引擎**: 支持无缝切换GitHub仓库的核心逻辑

### 技术亮点

- **异步并发**: 使用 aiohttp 进行高效的异步HTTP请求
- **会话持久化**: 使用 aiosqlite 实现轻量级任务状态存储
- **智能超时**: 多层超时机制，区分HTTP请求和用户会话
- **状态管理**: 完善的任务生命周期管理和错误恢复
- **用户体验优化**: 静默分析、智能提示、无缝切换

## 贡献

欢迎提交 Issue 和 Pull Request 来改进这个插件！

## 更新日志

### v1.1.0 (最新)
- ✨ 新增仓库切换功能：支持在问答过程中快速切换到其他仓库
- 🔄 优化会话管理：问答超时时间延长至30分钟
- 🛡️ 智能重复检测：防止30秒内重复问题处理
- 📊 静默分析模式：分析过程不再显示进度消息，提升用户体验
- 🎯 修复会话意外结束问题：确保问答后正确继续会话
- 💫 支持直接URL输入切换：检测到GitHub URL自动进行仓库切换

### v1.0.0
- 🎉 初始版本发布
- 🔍 支持 GitHub 仓库分析和智能问答
- 💾 实现状态持久化和会话管理
- ⚙️ 提供可视化配置界面

## 支持

[AstrBot 帮助文档](https://astrbot.app)
